<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>ASCO Aerial Autonomy: Creating an Autonomy Application</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="code.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ASCO Aerial Autonomy
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Creating an Autonomy Application </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>To create a new autonomy application, we need to create a new state machine which defines the logic flow and a robot system which coordinates the hardware on the physical (or virtual) robot. We need to implement the following components:</p>
<table class="doxtable">
<tr>
<th>Component </th><th>Description  </th></tr>
<tr>
<td>Robot System </td><td>Provides sensor data and accepts control commands </td></tr>
<tr>
<td>Robot System Handler </td><td>Instantiates robot system and manages its control threads </td></tr>
<tr>
<td>Actions </td><td>Commands to execute when switching between states </td></tr>
<tr>
<td>Guards </td><td>Check if the transition between states is valid or not </td></tr>
<tr>
<td>Internal Actions </td><td>Process robot state continuously and trigger actions accordingly </td></tr>
</table>
<h2>Creating a Robot System</h2>
<p>A robot system is responsible for owning any <a class="el" href="md_markdown_class_groups.html">ControllerHardwareConnectors</a> and interacting with any hardware that the autonomy application will be utilizing. Examples can be found in <a href="https://github.com/jhu-asco/aerial_autonomy/tree/master/include/aerial_autonomy/robot_systems">include/robot_systems</a>. New robot systems should extend <a class="el" href="classBaseRobotSystem.html" title="Provides functions to switch between active controllers and get goals. ">BaseRobotSystem</a> and add any ControllerHardwareConnectors to the system in the derived class constructor using <code>controller_hardware_connector_container_.setObject(my_controller_connector_)</code>. Keep in mind that only one instance of each <a class="el" href="classControllerHardwareConnector.html" title="Performs a single step of extracting data, running controller and sending data back to hardware...">ControllerHardwareConnector</a> type can be stored in the container. The new robot system should expose any additional hardware functionality that will be used in the state machine, e.g. <code>takeoff()</code> or <code>land()</code> for the <code><a class="el" href="classUAVSystem.html" title="Owns, initializes, and facilitates communication between different hardware/software components...">UAVSystem</a></code>.</p>
<p>The state machine actions will have access to the robot system and interact with controllers by calling the robot system <code>setGoal</code> function templated on the controller it wants to use to navigate to the given goal.</p>
<h2>Creating Actions</h2>
<p>Actions define commands to execute when transitioning between states. Examples can be found in <code>include/actions_guards</code>. Actions which do not need access to the event which triggered the action should derive from <code><a class="el" href="structEventAgnosticActionFunctor.html" title="Action functor that does not require the event triggering it. ">EventAgnosticActionFunctor</a>&lt;RobotSystemT, LogicStateMachineT&gt;</code> and override the <code>run(RobotSystemT&amp; LogicStateMachineT&amp;)</code> function with the command to be executed. See <code>include/land_functors.h</code> for an example.</p>
<p>Actions which do need access to the triggering event should derive from <code><a class="el" href="structActionFunctor.html" title="Action Functor for a given event, robot system, state machine. ">ActionFunctor</a>&lt;EventT, RobotSystemT, LogicStateMachineT&gt;</code> and override the run function with the command to execute. See <code>include/position_control_functors.h</code> for an example.</p>
<h2>Creating Internal Actions</h2>
<p>Internal actions define a behavior that is executed while in a particular state. They should derive from <code><a class="el" href="structEventAgnosticActionFunctor.html" title="Action functor that does not require the event triggering it. ">EventAgnosticActionFunctor</a>&lt;RobotSystemT, LogicStateMachineT&gt;</code> and override its <code>run</code> function with the intended behavior. See <code><a class="el" href="structPositionControlInternalActionFunctor__.html" title="Logic to check while reaching a position control goal. ">PositionControlInternalActionFunctor_</a></code> in <code>include/position_control_functors.h</code> for an example.</p>
<h2>Creating Guards</h2>
<p>Guards check if a triggered transition between states is valid or not. For example, the <code><a class="el" href="structTakeoffTransitionGuardFunctor__.html" title="Guard to avoid accidental takeoff. ">TakeoffTransitionGuardFunctor_</a></code> keeps a <code><a class="el" href="classUAVSystem.html" title="Owns, initializes, and facilitates communication between different hardware/software components...">UAVSystem</a></code> from taking off if the battery level percentage is below some threshold. Guards which do not need access to the triggering event should derive from <code><a class="el" href="structEventAgnosticGuardFunctor.html" title="Guard functor that does not require the event triggering it. ">EventAgnosticGuardFunctor</a>&lt;RobotSystemT, LogicStateMachineT&gt;</code> and override the <code>guard</code> function to return true when a transition is valid and false otherwise.</p>
<p>Guards which do need access to the triggering event should inherit from <code><a class="el" href="structGuardFunctor.html" title="Action Functor for a given event, robot system, state machine. ">GuardFunctor</a>&lt;EventT, RobotSystemT, LogicStateMachineT&gt;</code> and override its <code>guard</code> fuction. See <code><a class="el" href="structPositionControlTransitionGuardFunctor__.html" title="Guard function to check the goal is within tolerance before starting towards goal. ">PositionControlTransitionGuardFunctor_</a></code> in <code>include/position_control_functors.h</code> for an example.</p>
<h2>Creating a State Machine</h2>
<p>The state machine defines the logic of the system using the defined actions, states, and guards. A "front end" for the state machine defines the connections and transitions between states. The front end should derive from both <code>msmf::state_machine_def&lt;StateMachineFrontEnd&gt;</code> and <code><a class="el" href="classBaseStateMachine.html" title="Base state machine. ">BaseStateMachine</a>&lt;RobotSystemT&gt;</code>. Its <code>transition_table</code> will define the state machine itself by specifying which action will cause which state transitions and which guards will check the validity of the transitions. See <code>include/state_machines/uav_state_machine.h</code> and its associated flow chart below for an example and see <a href="http://www.boost.org/doc/libs/1_63_0/libs/msm/doc/HTML/ch03s02.html">here</a> for a more in depth explanation of the underlying boost mechanisms.</p>
<div class="image">
<img src="state_machine.png"  alt="alt text" title="Example State Machine"/>
</div>
<p>The state machine that we will interact with will be of type <code><a class="el" href="classboost_1_1msm_1_1back_1_1thread__safe__state__machine.html" title="Thread safe state machine class that extends boost::msm::back::state_machine class. ">boost::msm::back::thread_safe_state_machine</a>&lt;StateMachineFrontEnd&gt;</code>.</p>
<p>Any new state machine must include <code>using <a class="el" href="classBaseStateMachine.html" title="Base state machine. ">BaseStateMachine</a>&lt;<a class="el" href="classUAVSystem.html" title="Owns, initializes, and facilitates communication between different hardware/software components...">UAVSystem</a>&gt;::no_transition</code> to avoid type ambiguities.</p>
<h2>Creating a System Handler</h2>
<p>The system handler should have a member of type <code><a class="el" href="classCommonSystemHandler.html" title="Provides logic common to different system handlers to reduce code duplication. ">CommonSystemHandler</a>&lt;LogicStateMachineT, EventManagerT, RobotSystemT&gt;</code>, which will automatically take care of instantiating and managing the logic state machine it is templated on. The system handler must call the <a class="el" href="classCommonSystemHandler.html" title="Provides logic common to different system handlers to reduce code duplication. ">CommonSystemHandler</a> <code>startTimers</code> function to start the state machine. The system handler will need to instantiate the robot system and any hardware drivers and spawn any timers for stepping controllers owned by the robot system. See <code>include/system_handlers/uav_system_handler.h</code> for an example.</p>
<h2>Creating a Node</h2>
<p>Create an executable with the following structure: </p>
<pre class="fragment">int main(int argc, char** argv) {
  ros::init(argc, argv);
  ros::NodeHandle nh;
  // Load config into config
  MySystemHandler&lt;MyStateMachine, MyEventManager&gt;(nh, config)
  ros::spin();
} 
</pre><p>See <code><a class="el" href="uav__system__node_8cpp.html">src/system_handler_nodes/uav_system_node.cpp</a></code> for an example. </p>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.6-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated for ASCO Aerial Autonomy &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
